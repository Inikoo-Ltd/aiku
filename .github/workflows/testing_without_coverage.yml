name: Backend Tests

on:
  push:
    branches: [ "main" ]

env:
  HOME: /home/aiku_test
  XDEBUG_MODE: coverage

jobs:
  laravel-tests:
    name: Run backend tests ðŸ§ª
    runs-on: [ self-hosted ]
    steps:
      - name: Checkout repo
        uses: actions/checkout@v6
        with:
          fetch-depth: 1
      - name: Composer install
        run: php8.4 /usr/local/bin/composer install --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist
      - name: Prepare environment
        run: |
          ln -s ../../../../.pgpass .pgpass
          ln -s ../../../../env.aiku.testing .env.testing
          ln -s ../../../../env.aiku.testing .env
          ln -s ../../../../../artifacts/public/grp public/grp
          ln -s ../../../../../artifacts/public/iris public/iris
          ln -s ../../../../../artifacts/public/retina public/retina
          ln -s ../../../../../artifacts/public/aiku-public public/aiku-public
          mkdir private
          cd private
          ln -s ../../../../../artifacts/fa .
      - name: Generate database dumps ðŸ“š
        run: ./generate_testing_db_dumps.sh php8.4 -dxdebug.mode=off aiku_test;cp tests/datasets/db_dumps/aiku.dump ../../../../artifacts/
      - name: Retrieve db dumps
        run: cp ../../../../artifacts/aiku.dump tests/datasets/db_dumps/
      - name: Run test without coverage
        run: /usr/bin/php8.4 -dxdebug.mode=off vendor/bin/pest --exclude-group=integration --stop-on-defect
