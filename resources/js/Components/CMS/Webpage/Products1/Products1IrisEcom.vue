<script setup lang="ts">
import { faFilter } from "@fas"
import { FontAwesomeIcon } from "@fortawesome/vue-fontawesome"
import { getStyles } from "@/Composables/styles"
import { ref, onMounted, watch, computed, toRaw, inject } from "vue"
import axios from "axios"
import Button from "@/Components/Elements/Buttons/Button.vue"
import { notify } from "@kyvg/vue3-notification"
import { routeType } from "@/types/route"
import FilterProducts from "./FilterProduct.vue"
import Drawer from "primevue/drawer"
import Skeleton from "primevue/skeleton"
import { debounce } from "lodash-es"
import LoadingText from "@/Components/Utils/LoadingText.vue"
import { retinaLayoutStructure } from "@/Composables/useRetinaLayoutStructure"
import PureInput from "@/Components/Pure/PureInput.vue"
import { useConfirm } from "primevue/useconfirm"
import { faSearch } from "@fal"
import { faExclamationTriangle, faLayerGroup } from "@far"
import ConfirmDialog from "primevue/confirmdialog"
import { trans } from "laravel-vue-i18n"
import FontSize from "tiptap-extension-font-size"
import ButtonAddCategoryToPortfolio from "@/Components/Iris/Products/ButtonAddCategoryToPortfolio.vue"
import ProductRenderEcom from "./ProductRenderEcom.vue"


const props = defineProps<{
    fieldValue: {
        card_product: { properties: {} }
        products_route: {
            iris: {
                route_products: routeType,
                route_out_of_stock_products: routeType
            }
            workshop: routeType
        }
        products: {
            data: {},
            links: {},
            meta: {
                current_page: number,
                last_page: number,
                total: number
            }
        }
        container?: any
        model_type: string
        model_id: number
    }
    webpageData?: any
    blockData?: {}
    screenType: "mobile" | "tablet" | "desktop"
}>()

const layout = inject("layout", retinaLayoutStructure)
const products = ref<any[]>(
  props.fieldValue?.products?.meta?.last_page == 1
    ? [
        ...(props.fieldValue?.products?.data ?? []),
        ...(props.fieldValue?.products_out_of_stock?.data ?? [])
      ]
    : [...(props.fieldValue?.products?.data ?? [])]
);

const q = ref("")
const orderBy = ref(route()?.params?.order_by)
const page = ref(toRaw(props.fieldValue.products.meta.current_page))
const lastPage = ref(toRaw(props.fieldValue.products.meta.last_page))
const filter = ref({ data: {} })
const totalProducts = ref(props.fieldValue.products.meta.total)

const isShowFilters = ref(false)
const isShowAside = ref(false)
const isFetchingOutOfStock = ref(false)
const isNewArrivals = ref(false)
const isLoadingInitial = ref(false)
const isLoadingMore = ref(false)


const getRoutes = () => {
    if (props.fieldValue.model_type === "ProductCategory") {
        return {
            iris: {
                route_products: {
                    name: "iris.json.product_category.products.index",
                    parameters: { productCategory: props.fieldValue.model_id }
                },
                route_out_of_stock_products: {
                    name: "iris.json.product_category.out_of_stock_products.index",
                    parameters: { productCategory: props.fieldValue.model_id }
                }
            }
        }
    } else if (props.fieldValue.model_type === "Collection") {
        return {
            iris: {
                route_products: {
                    name: "iris.json.collection.products.index",
                    parameters: { collection: props.fieldValue.model_id }
                },
                route_out_of_stock_products: {
                    name: "iris.json.collection.out_of_stock_products.index",
                    parameters: { collection: props.fieldValue.model_id }
                }
            }
        }
    }

    return { iris: { route_products: null, route_out_of_stock_products: null } }
}

function buildFilters(): Record<string, any> {
    const filters: Record<string, any> = {}
    const raw = filter.value.data || {}

    for (const [key, val] of Object.entries(raw)) {
        if (val === null || val === undefined || val === '') continue

        if (key === 'price_range') {
            const rawMin = val['between[price_min]']
            const rawMax = val['between[price_max]']

            const hasMin = rawMin !== '' && rawMin != null && !isNaN(rawMin)
            const hasMax = rawMax !== '' && rawMax != null && !isNaN(rawMax)

            if (hasMin || hasMax) {
                const min = hasMin ? Number(rawMin) : 0
                const max = hasMax ? Number(rawMax) : 0

                if (!(min === 0 && max === 0)) {
                    filters[`filter[${key}]`] = `${min},${max}` // ← no brackets
                }
            }
        } else if (typeof val === 'object' && !Array.isArray(val)) {
            for (const [subKey, subVal] of Object.entries(val)) {
                if (subVal === null || subVal === undefined || subVal === '') continue
                filters[subKey] = subVal
            }
        } else if (Array.isArray(val)) {
            filters[`filter[${key}]`] = val.join(',')
        } else {
            filters[`filter[${key}]`] = val
        }
    }

    if (isNewArrivals.value) {
        filters[`filter[new_arrivals]`] = 3
    }

    console.log("Filters sent to URL:", filters)
    return filters
}



const fetchProducts = async (isLoadMore = false, ignoreOutOfStockFallback = false) => {
    if (isLoadMore) {
        isLoadingMore.value = true
    } else {
        isLoadingInitial.value = true
    }

    const filters = buildFilters()
    console.log("Filters used in API call:", filters)
    const routes = getRoutes()
    const useOutOfStock = isFetchingOutOfStock.value

    const currentRoute = useOutOfStock
        ? routes.iris.route_out_of_stock_products
        : routes.iris.route_products

    try {
        const response = await axios.get(route(currentRoute.name, {
            ...currentRoute.parameters,
            ...filters,
            "filter[global]": q.value,
            sort: orderBy.value,
            index_perPage: 25,
            page: page.value
        }))

        const data = response.data

        lastPage.value = data?.meta?.last_page ?? data?.last_page ?? 1
        totalProducts.value = data?.meta?.total ?? data?.total ?? 0

        if (isLoadMore) {
            products.value = [...products.value, ...(data?.data ?? [])]
        } else {
            products.value = data?.data ?? []
        }

        if (!ignoreOutOfStockFallback && !useOutOfStock && page.value >= lastPage.value) {
            isFetchingOutOfStock.value = true
            page.value = 1
            await fetchProducts(true, true)
        }

    } catch (error) {
        console.log(error)
        notify({ title: "Error", text: "Failed to load products.", type: "error" })
    } finally {
        isLoadingInitial.value = false
        isLoadingMore.value = false
    }
}


const debFetchProducts = debounce(fetchProducts, 300)

const handleSearch = () => {
    page.value = 1
    isFetchingOutOfStock.value = false
    updateQueryParams()
    debFetchProducts(false, true)
}


watch([q, orderBy], () => {
    page.value = 1
    isFetchingOutOfStock.value = false
    updateQueryParams()
    debFetchProducts(false, true)
}, { deep: true })

watch(filter, () => {
    page.value = 1
    isFetchingOutOfStock.value = false
    /* updateQueryParams(); */
    debFetchProducts(false, true)
}, { deep: true })


const loadMore = () => {
    if (page.value < lastPage.value && !isLoadingMore.value) {
        page.value += 1
        debFetchProducts(true)
    }
}

const sortOptions = computed(() => {
    const baseOptions = [
        /* { label: "Latest Arrivals", value: "created_at" }, */
        { label: trans("New arrivals"), value: "created_at" },
        { label: trans("Product Code"), value: "code" },
        { label: trans("Name"), value: "name" }
    ]
    if (layout?.iris?.is_logged_in) {
        baseOptions.splice(1, 0, { label: trans("Price"), value: "price" })
        baseOptions.splice(1, 0, { label: trans("RRP"), value: "rrp" })
    }
    return baseOptions
})

const sortKey = ref("created_at")
const isAscending = ref(true)


const getArrow = (key: typeof sortKey.value) => {
    if (sortKey.value !== key) return ""
    return isAscending.value ? "↑" : "↓"
}


const isMobile = computed(() => props.screenType === "mobile")

onMounted(() => {
    const urlParams = new URLSearchParams(window.location.search)
    const sortParam = urlParams.get("order_by")

    if (sortParam) {
        orderBy.value = sortParam
        const key = sortParam.replace("-", "")
        sortKey.value = key as typeof sortKey.value
        isAscending.value = !sortParam.startsWith("-")
    }

    if (layout?.iris?.is_logged_in){
        fetchProducts();
        fetchHasInBasket();
    }
})

const updateQueryParams = () => {
    const url = new URL(window.location.href)

    // Reset existing filter params
    Array.from(url.searchParams.keys()).forEach(key => {
        if (key.startsWith("filter[")) {
            url.searchParams.delete(key)
        }
    })

    // Update sorting
    if (orderBy.value) {
        url.searchParams.set("order_by", orderBy.value)
    } else {
        url.searchParams.delete("order_by")
    }

    // Update filters
    /*    const filters = buildFilters(); */
    /* for (const [key, val] of Object.entries(filters)) {
        url.searchParams.set(`filter[${key}]`, val);
    } */

    window.history.replaceState({}, "", url.toString())
}

const toggleSort = (key: string) => {
    if (sortKey.value === key) {
        isAscending.value = !isAscending.value
    } else {
        sortKey.value = key
        isAscending.value = true
    }
    
    orderBy.value = isAscending.value ? key : `-${key}`
    updateQueryParams()
    handleSearch()
}


const productInBasket = ref({
    isLoading: false,
    list: []
})

const getRouteForProductInBasket = () => {
    const { model_type, model_id } = props.fieldValue;
    if (model_type == "ProductCategory") {
        return route("iris.json.product_category.transaction_data", {
            productCategory: model_id
        });
    } else if (model_type == "Collection") {
        return route("iris.json.collection.transaction_data", {
            collection: model_id
        });
    }
};

const fetchHasInBasket = async () => {
    productInBasket.value.isLoading = true;
    try {
        const apiUrl = getRouteForProductInBasket();

        if (!apiUrl) {
            throw new Error("Invalid model_type or missing route configuration");
        }

        const response = await axios.get(apiUrl);
        productInBasket.value.list = response.data || [];
    } catch (error) {
        console.error(error);
        notify({
            title: "Error",
            text: "Failed to load product portfolio.",
            type: "error"
        });
    } finally {
        productInBasket.value.isLoading = false;
    }
};



const responsiveGridClass = computed(() => {
    const perRow = props.fieldValue?.settings?.per_row ?? {}

    const columnCount = {
        desktop: perRow.desktop ?? 4,
        tablet: perRow.tablet ?? 3,
        mobile: perRow.mobile ?? 2
    }

    const count = columnCount[props.screenType] ?? 1
    return `grid-cols-${count}`
})


</script>

<template>
    <div id="products-1-ecom">
        <ConfirmDialog>
            <template #icon>
                <FontAwesomeIcon :icon="faExclamationTriangle" class="text-yellow-500" />
            </template>
        </ConfirmDialog>
        <div class="flex flex-col lg:flex-row" :style="{
            ...getStyles(layout?.app?.webpage_layout?.container?.properties, screenType),
            ...getStyles(fieldValue.container?.properties, screenType)
        }">

            <!-- Sidebar Filters for Desktop -->
            <transition name="slide-fade">
                <aside v-show="!isMobile && isShowAside" class="w-68 p-4 transition-all duration-300 ease-in-out">
                    <FilterProducts v-model="filter" :productCategory="props.fieldValue.model_id" />
                </aside>
            </transition>

            <!-- Main Content -->
            <div class="flex-1">
                <!-- Search & Sort -->
                <div class="px-4 pt-4 pb-2 flex flex-col md:flex-row justify-between items-center gap-4">
                    <div class="flex items-center w-full md:w-1/3 gap-2">
                        <Button v-if="isMobile" :icon="faFilter" @click="isShowFilters = true" class="!p-3 !w-auto"
                            aria-label="Open Filters" />

                        <!-- Sidebar Toggle for Desktop -->
                        <div v-else class="py-4">
                            <Button :icon="faFilter" @click="isShowAside = !isShowAside" class="!p-3 !w-auto"
                                aria-label="Open Filters" />
                        </div>
                        <PureInput v-model="q" @keyup.enter="handleSearch" type="text" :placeholder="trans('Search products...')"
                            :clear="true" :isLoading="isLoadingInitial" :prefix="{ icon: faSearch, label: '' }" />
                    </div>

                    <!-- Sort Tabs -->
                    <div class="flex xspace-x-6 overflow-x-auto mt-2 md:mt-0">
                        <!-- <button @click="toggleNewArrivals"
                            class="pb-2 text-sm font-medium whitespace-nowrap flex items-center gap-1" :class="[
                            isNewArrivals
                                ? `border-b-2 text-[${layout?.app?.theme?.[0] || '#1F2937'}] border-[${layout?.app?.theme?.[0] || '#1F2937'}]`
                                : `text-gray-600 hover:text-[${layout?.app?.theme?.[0] || '#1F2937'}]`
                        ]">
                            New Arrivals
                        </button> -->

                        <button v-for="option in sortOptions" :key="option.value" @click="toggleSort(option.value)"
                            class="pb-2 px-4 text-sm font-medium whitespace-nowrap flex items-center border-b-2 gap-1" :class="[
                                sortKey === option.value
                                    ? `border-[var(--iris-color-0)] text-[var(--iris-color-0)]`
                                    : `border-gray-300 text-gray-600 hover:text-[var(--iris-color-0)]`
                            ]"
                            :disabled="isLoadingInitial || isLoadingMore">
                            {{ option.label }} {{ getArrow(option.value) }}
                        </button>
                    </div>
                </div>
                
                <!-- Section: Results  -->
                <div class="px-4 mb-2 flex justify-between items-center text-sm text-gray-600">
                    <div
                        class="flex items-center gap-3 p-4 bg-gray-50 rounded-md border border-gray-200 shadow-sm text-sm">
                        <span class="font-medium">
                            {{ trans("Showing") }}
                            <span :class="['font-semibold', `text-[${layout?.app?.theme?.[0] || '#1F2937'}]`]">{{
                                products.length }}</span>
                            {{ trans("of") }}
                            <span :class="['font-semibold', `text-[${layout?.app?.theme?.[0] || '#1F2937'}]`]">{{
                                totalProducts }}</span>
                            {{ products.length === 1 ? trans("product") : trans("products") }}
                        </span>
                    </div>

                    <div>
                        <!-- <ButtonAddCategoryToPortfolio xproduct="fieldValue.product" :products :categoryId
                            xproductHasPortfolio="productExistenceInChannels" /> -->
                    </div>
                </div>

                <!-- Product Grid -->
                <div :class="responsiveGridClass" class="grid gap-6 p-4"
                    :style="getStyles(fieldValue?.container?.properties, screenType)">
                    <template v-if="isLoadingInitial">
                        <div v-for="n in 10" :key="n" class="border p-3 rounded shadow-sm bg-white">
                            <Skeleton height="200px" class="mb-3" />
                            <Skeleton width="80%" class="mb-2" />
                            <Skeleton width="60%" class="mb-2" />
                            <Skeleton width="100%" />
                        </div>
                    </template>

                    <template v-else-if="products.length">
                        <div v-for="(product, index) in products" :key="index"
                            :style="getStyles(fieldValue?.card_product?.properties, screenType)"
                            class="border relative rounded"
                            :class="product.stock ? '' : 'bg-red-100'"
                        >
                            <ProductRenderEcom
                                :product="product"
                                :key="index"
                                :hasInBasket="productInBasket.list[product.id]"
                            />
                        </div>
                    </template>

                    <template v-else>
                        <div class="col-span-full text-center py-10 text-gray-500">
                        </div>
                    </template>
                </div>

                <!-- Load More -->
                <!--  {{ page   }}{{ lastPage }} -->
                <div v-if="page < lastPage && !isLoadingInitial" class="flex justify-center my-4  mb-12">
                    <Button @click="loadMore" type="tertiary" :disabled="isLoadingMore"
                        :injectStyle="{ padding: '14px 65px', fontSize: '1.2rem' }">
                        <template v-if="isLoadingMore">
                            <LoadingText />
                        </template>
                        <template v-else>{{ trans("Load More") }}</template>
                    </Button>
                </div>
            </div>

            <!-- Mobile Filters Drawer -->
            <Drawer v-model:visible="isShowFilters" position="left" :modal="true" :dismissable="true"
                :closeOnEscape="true" :showCloseIcon="false" class="w-80 transition-transform duration-300 ease-in-out">
                <div class="p-4">
                    <FilterProducts v-model="filter" :productCategory="props.fieldValue.model_id" />
                </div>
            </Drawer>
        </div>
    </div>
</template>


<style scoped>
.slide-fade-enter-active,
.slide-fade-leave-active {
    transition: all 0.3s ease;
}

.slide-fade-enter-from,
.slide-fade-leave-to {
    opacity: 0;
    transform: translateX(-10px);
}

aside {
    transition: all 0.3s ease;
}
</style>
