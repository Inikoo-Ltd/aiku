<script setup lang="ts">
import { inject, ref } from "vue"
import { router } from "@inertiajs/vue3"
import { layoutStructure } from "@/Composables/useLayoutStructure"
import LoadingIcon from "@/Components/Utils/LoadingIcon.vue"
import ToggleSwitch from "primevue/toggleswitch"
import { get } from "lodash"

const props = defineProps<{
	intervalOptions: {
		label: string
		value: string
	}[]
	settings: {
		db_settings: {
			selected_interval?: string
			selected_currency_in_grp?: string
			selected_currency_in_org?: string
			selected_shop_open?: string
			selected_shop_closed?: string
		}
		key_currency?: string
		key_shop?: string
		options_currency: {
			value: string
			label: string
		}[]
		options_shop: {
			value: string
			label: string
		}[]
	}
	tableType?: string
}>()

const layout = inject("layout", layoutStructure)

// Section: Interval
const isLoadingInterval = ref<string | null>(null)
const updateInterval = (interval_code: string) => {
	router.patch(
		route("grp.models.user.update", layout.user?.id),
		{
			settings: {
				selected_interval: interval_code,
			},
		},
		{
			onStart: () => {
				isLoadingInterval.value = interval_code
			},
			onFinish: () => {
				isLoadingInterval.value = null
			},
			preserveScroll: true,
		}
	)
}

// Section: Currency
const isLoadingCurrency = ref<boolean>(false)
const updateCurrency = (currency_scope: string) => {
	router.patch(
		route("grp.models.user.update", layout.user?.id),
		{
			settings: {
				[`selected_currency_in_${props.settings?.key_currency || "grp"}`]: currency_scope,
			},
		},
		{
			onStart: () => {
				isLoadingCurrency.value = true
			},
			onFinish: () => {
				isLoadingCurrency.value = false
			},
			preserveScroll: true,
		}
	)
}

const updateShop = (shop_scope: string) => {
	router.patch(
		route("grp.models.user.update", layout.user?.id),
		{
			settings: {
				[`selected_shop_open`]: shop_scope,
			},
		},
		{
			onStart: () => {
				isLoadingCurrency.value = true
			},
			onFinish: () => {
				isLoadingCurrency.value = false
			},
			preserveScroll: true,
		}
	)
}
</script>

<template>
	<div
		class="relative bg-gradient-to-r mb-2 from-white to-gray-50 p-6 rounded-xl shadow-md space-y-6 border border-gray-200">
		<!-- Section: Currency -->
		<div class="flex flex-wrap justify-between items-center gap-4 lg:gap-8">
			<!-- Shop Toggle with Labels -->
			<div class="flex items-center space-x-4" v-if="tableType === 'org'">
				<p
					class="font-medium"
					:class="[
						settings.db_settings.selected_shop_open === settings.options_shop[1].value
							? 'text-black font-bold'
							: 'opacity-50',
					]">
					{{ settings.options_shop[1].label }}
				</p>

				<!-- Shop Toggle Switch -->
				<ToggleSwitch
					:modelValue="settings.db_settings.selected_shop_open === 'open'"
					@update:modelValue="(value) => updateShop(value ? 'open' : 'closed')"
					:trueValue="true"
					:falseValue="false" />

				<!-- Right Label -->
				<p
					class="font-medium"
					:class="[
						settings.db_settings.selected_shop_open === settings.options_shop[0].value
							? 'text-black font-bold'
							: 'opacity-50',
					]">
					{{ settings.options_shop[0].label }}
				</p>
			</div>
			<div v-else></div>

			<!-- Currency Toggle with Labels -->
			<div class="flex items-center justify-end space-x-4">
				<p
					class="font-medium"
					:class="[
						settings.options_currency[0].value ===
						get(
							settings,
							['db_settings', `selected_currency_in_${settings.key_currency}`],
							''
						)
							? ''
							: 'opacity-50',
					]">
					{{ settings.options_currency[0].label }}
				</p>

				<!-- Currency Toggle Switch -->
				<ToggleSwitch
					:modelValue="
						get(
							settings,
							['db_settings', `selected_currency_in_${settings.key_currency}`],
							''
						)
					"
					@update:modelValue="(e: string) => updateCurrency(e)"
					class="mx-2"
					:disabled="isLoadingCurrency"
					:trueValue="settings.options_currency[1].value"
					:falseValue="settings.options_currency[0].value" />

				<!-- Right Label -->
				<p
					class="font-medium"
					:class="[
						settings.options_currency[1].value ===
						get(
							settings,
							['db_settings', `selected_currency_in_${settings.key_currency}`],
							''
						)
							? ''
							: 'opacity-50',
					]">
					{{ settings.options_currency[1].label }}
				</p>
			</div>
		</div>

		<!-- Section: Interval -->
		<nav
			class="isolate flex rounded-full bg-white-50 border border-gray-200 p-1 hidden sm:flex"
			aria-label="Tabs">
			<div
				v-for="(interval, idxInterval) in intervalOptions"
				:key="idxInterval"
				@click="updateInterval(interval.value)"
				:class="[
					interval.value === settings.db_settings.selected_interval
						? 'bg-indigo-500 text-white font-medium'
						: 'text-gray-500 hover:text-gray-700 hover:bg-gray-100',
				]"
				v-tooltip="interval.label"
				class="relative flex-1 rounded-full py-2 px-4 text-center text-sm cursor-pointer select-none transition duration-200">
				<span :class="isLoadingInterval == interval.value ? 'opacity-0' : ''">{{
					interval.value
				}}</span>
				<span
					class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2"
					:class="isLoadingInterval == interval.value ? '' : 'opacity-0'"
					><LoadingIcon
				/></span>
			</div>
		</nav>
		<div class="block sm:hidden">
			<label for="intervalDropdown" class="sr-only">Select Interval</label>
			<select
				id="intervalDropdown"
				class="w-full border-gray-300 rounded-md text-sm"
				v-model="settings.db_settings.selected_interval"
				@change="updateInterval($event.target.value)">
				<option
					v-for="(interval, idxInterval) in intervalOptions"
					:key="idxInterval"
					:value="interval.value">
					{{ interval.value }}
				</option>
			</select>
		</div>
	</div>
</template>
