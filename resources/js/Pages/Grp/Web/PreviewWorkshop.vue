<!--
  - Author: Artha <artha@aw-advantage.com>
  - Created: Thu, 26 Sep 2024 13:18:33 Central Indonesia Time, Sanur, Bali, Indonesia
  - Copyright (c) 2024, Raul A Perusquia Flores
  -->

<script setup lang="ts">
import { getComponent } from '@/Composables/getWorkshopComponents'
import { getIrisComponent } from '@/Composables/getIrisComponents'
import { ref, onMounted, provide, onBeforeUnmount, inject, watch, computed } from 'vue'
import WebPreview from "@/Layouts/WebPreview.vue";
import { sendMessageToParent } from '@/Composables/Workshop'
import RenderHeaderMenu from './RenderHeaderMenu.vue'
import { router } from '@inertiajs/vue3'
import "@/../css/Iris/editor.css"
import { getStyles } from "@/Composables/styles";
import { Root as RootWebpage } from '@/types/webpageTypes'
import ButtonPreviewLogin from '@/Components/Workshop/Tools/ButtonPreviewLogin.vue';
import { faTimes } from "@fal"
import { library } from "@fortawesome/fontawesome-svg-core"
library.add(faTimes)

defineOptions({ layout: WebPreview })
const props = defineProps<{
    webpage?: RootWebpage
    header: {
        data: {}
    }
    footer: {
        footer: {}
    }
    navigation: {
        menu: {}
    }
    layout: {

    },
    sidebar: {}
}>()


const isOpenMenuMobile = inject('isOpenMenuMobile', ref(false))
const layout: any = inject("layout", {});
const isPreviewLoggedIn = ref(false)
const { mode } = route().params;
const isPreviewMode = ref(mode != 'iris' ? false : true)
const isInWorkshop = route().params.isInWorkshop || false
const screenType = ref<'mobile' | 'tablet' | 'desktop'>('desktop')
const active_language = ref<string|null>(null)
const defaultCurrency = {
  code: "GBP",
  symbol: "Â£",
  name: "British Pound"
}

// Update iris layout state
const updateIrisLayout = (isLoggedIn: boolean) => {
  layout.iris = {
    currency: defaultCurrency,
    is_logged_in: isLoggedIn,
  }
  router.reload()
}

const showWebpage = (activityItem) => {
    if (activityItem?.web_block?.layout && activityItem.show) {
        if (isPreviewLoggedIn.value && activityItem.visibility.in) return true
        else if (!isPreviewLoggedIn.value && activityItem.visibility.out) return true
        else return false
    } else return false
}

const updateData = (newVal) => {
    sendMessageToParent('autosave', newVal)
}


onMounted(() => {
    layout.app.theme = props?.layout?.color,
    layout.app.webpage_layout = props?.layout
    updateIrisLayout(isPreviewLoggedIn.value)
    window.addEventListener('message', (event) => {
        if (event.data.key === 'isPreviewLoggedIn') isPreviewLoggedIn.value = event.data.value
        if (event.data.key === 'isPreviewMode') isPreviewMode.value = event.data.value
        if (event.data.key === 'active_language') active_language.value = event.data.value
        if (event.data.key === 'reload') {
            router.reload({
                only: ['footer', 'header', 'webpage', 'navigation', 'sidebar'],
            });
        }
    });
    checkScreenType()
    window.addEventListener('resize', checkScreenType)

    if (props.sidebar && route().current()?.includes('sidebar')) {
        isOpenMenuMobile.value = true
    }
});


const checkScreenType = () => {
    const width = window.innerWidth
    if (width < 640) screenType.value = 'mobile'
    else if (width >= 640 && width < 1024) screenType.value = 'tablet'
    else screenType.value = 'desktop'
}

onBeforeUnmount(() => {
    window.removeEventListener('resize', checkScreenType)
})


provide('isPreviewLoggedIn', isPreviewLoggedIn)
provide('isPreviewMode', isPreviewMode)
const compSidebar = computed(() => {
    return props?.sidebar?.sidebar
})
provide('sidebarMenu', compSidebar)


watch(isPreviewLoggedIn, (value) => {
     updateIrisLayout(isPreviewLoggedIn.value)
}, { immediate: true });

</script>


<template>
    <div class="editor-class" :class="route().params?.mode !== 'iris' ? 'is-not-mode-iris' : ''">
        <div v-if="isInWorkshop" class="bg-gray-200 shadow-xl px-8 py-4 flex justify-center items-center gap-x-2">
            <ButtonPreviewLogin v-model="isPreviewLoggedIn" />
        </div>

        <div class="shadow-xl" :class="props.layout?.layout == 'fullscreen' ? 'w-full' : 'container max-w-7xl mx-auto'">
            <div>
                <RenderHeaderMenu
                    v-if="header?.data"
                    :data="header.data"
                    :menu="navigation"
                    :loginMode="isPreviewLoggedIn"
                    @update:model-value="updateData(header.data)"
                    :screenType="screenType"
                    :sidebar
                />
            </div>

            <div class="bg-white" :style="getStyles(layout.container?.properties, screenType)">
                <template v-if="webpage?.layout?.web_blocks?.length">
                    <div v-for="(activityItem, activityItemIdx) in webpage?.layout?.web_blocks"
                        :key="'block' + activityItem.id" class="w-full">
                        <component v-if="showWebpage(activityItem)" :is="getIrisComponent(activityItem.type)"
                            :key="activityItemIdx" :theme="layout"
                            :fieldValue="activityItem.web_block?.layout?.data?.fieldValue" :screenType="screenType" />
                    </div>
                </template>
            </div>

            <!-- Footer -->
            <component v-if="footer?.data?.data"
                :is="isPreviewMode || route().current() == 'grp.websites.preview' || route().current() == 'grp.org.shops.show.web.webpages.snapshot.preview' ? getIrisComponent(footer.data.code) : getComponent(footer.data.code)"
                v-model="footer.data.data.fieldValue" @update:model-value="updateData(footer.data)" />
        </div>
    </div>

</template>



<style lang="scss">
.is-not-mode-iris {
    .hover-dashed {
        @apply relative;

        &::after {
            content: "";
            @apply absolute inset-0 hover:bg-gray-200/30 border border-transparent hover:border-white/80 border-dashed cursor-pointer;
        }
    }

    .hover-text-input {
        @apply relative isolate;

        &::after {
            content: "";
            @apply -z-10 absolute inset-0 hover:bg-yellow-500/30 border border-transparent hover:border-white/80 border-dashed cursor-pointer;
        }
    }
}

#jsd-widget{
    display: none !important;
}
</style>
