<script setup lang="ts">
import {Head, router,usePage} from "@inertiajs/vue3";
import PageHeading from "@/Components/Headings/PageHeading.vue";
import {capitalize} from "@/Composables/capitalize";
import {inject, ref, watch, onMounted } from "vue";

import {PageHeading as PageHeadingTypes} from "@/types/PageHeading";
import {Tabs as TSTabs} from "@/types/Tabs";
import Button from "@/Components/Elements/Buttons/Button.vue";
import {routeType} from "@/types/route";

import {trans} from "laravel-vue-i18n";
import Modal from "@/Components/Utils/Modal.vue";
import PureInputWithAddOn from "@/Components/Pure/PureInputWithAddOn.vue";
import PureInput from "@/Components/Pure/PureInput.vue";
import {notify} from "@kyvg/vue3-notification";

import {layoutStructure} from "@/Composables/useLayoutStructure";
import axios from "axios";
import {ChannelLogo} from "@/Composables/Icon/ChannelLogoSvg"
import PurePassword from "@/Components/Pure/PurePassword.vue";

import { FontAwesomeIcon } from "@fortawesome/vue-fontawesome"
import {faInfoCircle, faGlobe, faExternalLinkAlt, faUnlink, faUsers} from "@fal";
import { library } from "@fortawesome/fontawesome-svg-core"
library.add(faInfoCircle)

library.add(faGlobe, faExternalLinkAlt, faUnlink, faUsers);

const props = defineProps<{
    title: string,
    pageHead: PageHeadingTypes
    tabs: TSTabs
    shopify_url: string
    unlinkRoute: routeType
    fetchCustomerRoute: routeType
    tiktokAuth: {
        url: string
        isAuthenticated: boolean
        isAuthenticatedExpired: boolean
        tiktokName: string
        deleteAccountRoute: routeType
    }
    type_manual: {
        createRoute: routeType
        isAuthenticated: boolean
    }
    type_shopify: {
        createRoute: routeType
        connectRoute?: {
            url: string
        }
        isAuthenticated: boolean
        shopify_url: string
    }
    type_woocommerce: {
        connectRoute: routeType
        isConnected: boolean
    }
    type_ebay: {
        connectRoute: routeType
    }
    type_amazon: {
        connectRoute: routeType
    }
    type_magento: {
        connectRoute: routeType
    }
    total_channels: {
        manual: number
        shopify: number
        woocommerce: number
        tiktok: number
        ebay: number
        amazon: number
        magento: number
    }
}>();

const layout = inject("layout", layoutStructure);

const isModalOpen = ref<string | boolean>(false);
const websiteInput = ref<string | null>(null);
const isLoading = ref<string | boolean>(false);
const errorShopify = ref('')
const onCreateStoreShopify = async () => {
    errorShopify.value = ''
    isLoading.value = true
    try {
        const data = await axios['post'](
            route(props.type_shopify.createRoute.name, props.type_shopify.createRoute.parameters),
            {
                name: websiteInput.value
            }
        )
        isModalOpen.value = false;
        websiteInput.value = null;
        router.reload({
            only: ['total_channels']
        });
        window.open(data.data, "_blank");

    } catch (error) {
        errorShopify.value = error.response?.data?.message
        notify({
            title: trans("Something went wrong"),
            text: error.response?.data?.message,
            type: "error"
        });
    }
    isLoading.value = false

};

// Section: Woocommerce
const isModalWooCommerce = ref<boolean>(false);
const wooCommerceInput = ref({
    name: null as null | string,
    url: null as null | string
});
const onSubmitWoocommerce = async () => {
    try {
        const response = await axios.post(
            route(props.type_woocommerce?.connectRoute?.name, props.type_woocommerce.connectRoute.parameters),
            wooCommerceInput.value);
        isModalWooCommerce.value = false;
        wooCommerceInput.value.name = null;
        wooCommerceInput.value.url = null;

        window.location.href = response.data;
    } catch (error) {
        console.log("error", error);
        notify({
            title: trans("Something went wrong"),
            text: error.response?.data?.message,
            type: "error"
        });
    }
}

// Section: Manual
const isModalManual = ref(false)
const errManual = ref('')
const manualInput = ref({
    name: null as null | string,
});
const onSubmitManual = async () => {
    isLoading.value = true;
    try {
        const response = await axios.post(
            route(props.type_manual?.createRoute.name, props.type_manual?.createRoute.parameters),
            manualInput.value);
        isModalManual.value = false;
        manualInput.value.name = null;


        notify({
            title: trans("Success!"),
            text: trans("Your Manual store has been created."),
            type: "success",
        })
        router.get(
            route('retina.dropshipping.customer_sales_channels.show', {
                customerSalesChannel: response.data.slug
            })
        )
    } catch (error) {
        errManual.value = error.response?.data?.message
        notify({
            title: trans("Something went wrong"),
            text: error.response?.data?.message,
            type: "error"
        });
    }
    isLoading.value = false;
}

// Section: ebay
const onSubmitEbay = async () => {
    const response = await axios.post(
        route(props.type_ebay.connectRoute.name, props.type_ebay.connectRoute.parameters));

    window.location.href = response.data;
};

// Section: amazon
const onSubmitAmazon = async () => {
    const response = await axios.post(
        route(props.type_amazon.connectRoute.name, props.type_amazon.connectRoute.parameters));

    window.location.href = response.data;
};

// Section: Woocommerce
const isModalMagento = ref<boolean>(false);
const errMagento = ref('')
const magentoInput = ref({
    username: null as null | string,
    password: null as null | string,
    url: null as null | string
});

interface Modal {
    title: string
    description: string
    type: 'success' | 'error' | 'info' | 'warning'
}

watch(() => usePage().props?.flash?.modal, (modal: Modal) => {
    console.log('modal ret', modal)
    if (!modal) return

})

const onSubmitMagento = async () => {
    try {
        isLoading.value = true;
        const response = await axios.post(
            route(props.type_magento.connectRoute.name, props.type_magento.connectRoute.parameters), magentoInput.value);

        isModalMagento.value = false;
        magentoInput.value.name = null;

        notify({
            title: trans("Success!"),
            text: trans("Your Magento store has been created."),
            type: "success",
        })

        router.get(
            route('retina.dropshipping.customer_sales_channels.show', {
                customerSalesChannel: response.data.slug
            })
        )

    } catch (error) {
        errMagento.value = error.response?.data?.message
        notify({
            title: trans("Something went wrong"),
            text: error.response?.data?.message,
            type: "error"
        });
    }

    isLoading.value = false;
};

// Section: Ebay
const isModalEbay = ref(false)

const closeModalEbayDuplicate = () => {
    router.get(window.location.origin + window.location.pathname)
    isModalEbayDuplicate.value = false
}

const isModalEbayDuplicate = ref(false)
    // console.log('window', window.location)
    onMounted(() => {
    const query = new URLSearchParams(window.location.search)
    const status = query.get('status')
    const reason = query.get('reason')

        if (status === 'error' && reason === 'duplicate-ebay') {
            isModalEbayDuplicate.value = true
            // router.get(window.location.origin + window.location.pathname)
        }
    })
</script>

<template>

    <Head :title="capitalize(title)"/>
    <PageHeading :data="pageHead"/>
    <div class="px-6">
        <div class="text-xl py-2 w-fit">E-Commerce</div>
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <!-- Section: Manual -->
            <div class="bg-gray-50 border border-gray-200 rounded-md p-4 flex flex-col justify-between">
                <div
                    class="mb-4 border-b border-gray-300 pb-4 flex gap-x-4 items-center text-xl">
                    <img src="https://aw.aurora.systems/art/aurora_log_v2_orange.png" alt="" class="h-12">
                    <div class="flex flex-col">
                        <div class="font-semibold">{{ trans("Web") }}/API</div>
                        <div class="text-xs text-gray-500">{{ total_channels?.manual }} {{ trans("Channels") }}</div>
                    </div>
                </div>

                <div class="w-full flex justify-end">
                    <Button
                        @click="() => isModalManual = true"
                        :label="trans('Create')"
                        full
                    />
                </div>
            </div>

            <!-- Section: Shopify -->
            <div class="bg-gray-50 border border-gray-200 rounded-md p-4 flex flex-col justify-between">
                <div
                    class="mb-4 border-b border-gray-300 pb-4 flex gap-x-4 items-center text-xl">
                    <div v-html="ChannelLogo('shopify')" class="h-12"></div>
                    <div class="flex flex-col">
                        <div class="font-semibold">Shopify</div>
                        <div class="text-xs text-gray-500">{{ total_channels?.shopify }} {{ trans("Channels") }}</div>
                    </div>
                </div>
                <!-- Button: Connect -->
                <div class="relative w-full">
                    <Button @click="() => isModalOpen = 'shopify'" label="Connect" type="primary" full/>
                </div>
            </div>

            <!-- Section: Tiktok -->
            <div class="bg-gray-50 border border-gray-200 rounded-md p-4 flex flex-col justify-between">
                <div
                    class="mb-4 border-b border-gray-300 pb-4 flex gap-x-4 items-center text-xl">
                    <div v-html="ChannelLogo('tiktok')" class="h-12"
                         :class="layout?.app?.environment === 'production' ? 'grayscale opacity-40' : ''"></div>
                    <div class="flex flex-col">
                        <div class="font-semibold">Tiktok</div>
                        <div v-if="layout?.app?.environment === 'local' || layout?.app?.environment === 'staging'"
                             class="text-xs text-gray-500">{{ total_channels?.tiktok }} {{ trans("Channels") }}
                        </div>
                    </div>
                </div>

                <div class="w-full flex justify-end">
                    <a target="_blank" class="w-full" :href="tiktokAuth?.url">
                        <Button v-if="layout?.app?.environment === 'local'"
                            :label="tiktokAuth?.isAuthenticatedExpired ? trans('Re-connect') : trans('Connect')"
                            type="primary"
                            full
                            iconRight="fal fa-external-link-alt"
                        />
                        <Button v-else :label="trans('Coming soon')" type="tertiary" disabled full/>
                    </a>

                </div>
            </div>

            <!-- Section: Woocommerce -->
            <div class="bg-gray-50 border border-gray-200 rounded-md p-4 flex flex-col justify-between">
                <div
                    class="truncate mb-4 border-b border-gray-300 pb-4 flex gap-x-4 items-center text-xl">
                    <div v-html="ChannelLogo('woocommerce')" class="h-12"></div>

                    <div class="flex flex-col">
                        <div class="font-semibold text-lg">Woocommerce</div>
                        <div class="text-xs text-gray-500">
                            {{ total_channels?.woocommerce }} {{ trans("Channels") }}
                        </div>
                    </div>
                </div>

                <div class="w-full flex justify-end">
                    <Button
                        :label="trans('Connect')"
                        type="primary"
                        full
                        @click="() => isModalWooCommerce = true"
                    />
                </div>
            </div>
            <!-- Section: Ebay -->
            <div class="bg-gray-50 border border-gray-200 rounded-md p-4 flex flex-col justify-between">
                <div
                    class="mb-4 border-b border-gray-300 pb-4 flex gap-x-4 items-center text-xl">
                    <img src="https://cdn-icons-png.flaticon.com/512/888/888848.png"
                         alt="" class="h-12"
                    >

                    <div class="flex flex-col">
                        <div class="font-semibold">Ebay</div>
                        <div
                             class="text-xs text-gray-500">{{ total_channels?.ebay }} {{ trans("Channels") }}
                        </div>
                    </div>
                </div>

                <div class="w-full flex justify-end">

                    <Button
                        :label="trans('Connect')"
                        xtype="primary"
                        :type="total_channels?.ebay ? 'tertiary' : 'primary'"
                        full
                        :iconRight="total_channels?.ebay ? '' : 'fal fa-external-link-alt'"
                        @click="() => total_channels?.ebay ? isModalEbay = true : onSubmitEbay()"
                    />
                    <Button v-else :label="trans('Coming soon')" type="tertiary" disabled full/>

                </div>
            </div>

            <!-- Section: Amazon -->
            <div class="bg-gray-50 border border-gray-200 rounded-md p-4 flex flex-col justify-between">
                <div
                    class="mb-4 border-b border-gray-300 pb-4 flex gap-x-4 items-center text-xl">

                    <div v-html="ChannelLogo('amazon_simple')" class="h-12"
                         :class="layout?.app?.environment === 'production' ? 'grayscale opacity-40' : ''"></div>

                    <div class="flex flex-col">
                        <div class="font-semibold">Amazon</div>
                        <div v-if="layout?.app?.environment === 'local' || layout?.app?.environment === 'staging'"
                             class="text-xs text-gray-500">{{ total_channels?.amazon ?? 0 }} {{ trans("Channels") }}
                        </div>
                    </div>
                </div>

                <div class="w-full flex justify-end">
                    <Button
                        v-if="layout?.app?.environment === 'local' || layout?.app?.environment === 'staging'"
                        :label="trans('Connect')"
                        type="primary"
                        full
                        iconRight="fal fa-external-link-alt"
                        @click="onSubmitAmazon"
                    />

                    <Button v-else :label="trans('Coming soon')" type="tertiary" disabled full/>

                </div>
            </div>

            <!-- Section: Magento -->
            <div class="bg-gray-50 border border-gray-200 rounded-md p-4 flex flex-col justify-between">
                <div
                    class="mb-4 border-b border-gray-300 pb-4 flex gap-x-4 items-center text-xl">
                     <img src="https://cdn-icons-png.flaticon.com/512/825/825535.png"
                        alt="" class="h-12 filter"
                    >

                    <div class="flex flex-col">
                        <div class="font-semibold">Magento</div>
                        <div class="text-xs text-gray-500">{{ total_channels?.magento ?? 0 }} {{
                                trans("Channels")
                            }}
                        </div>
                    </div>
                </div>

                <div class="w-full flex justify-end">
                    <Button
                        v-if="layout?.app?.environment === 'local'"
                        :label="trans('Connect')"
                        type="primary"
                        full
                        @click="() => isModalMagento = true"
                    />
                    <Button v-else :label="trans('Coming soon')" type="tertiary" disabled full/>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Shopify -->
    <Modal :isOpen="!!isModalOpen" @onClose="isModalOpen = false" width="w-[600px]">
        <div class="h-fit">
            <div class="mb-6">
                <div class="text-center font-semibold text-xl">
                    {{ trans("Please enter your Shopify unique domain name") }}
                </div>

                <div class="text-center text-xs text-gray-500 w-9/12 mx-auto">
                    {{ trans("You will be able to find it in your Shopify settings under domains section.") }}
                </div>
            </div>

            <PureInputWithAddOn
                v-model="websiteInput"
                @update:model-value="() => errorShopify = ''"
                :leftAddOn="{
                    icon: 'fal fa-globe'
                }"
                :rightAddOn="{
                    label: shopify_url
                }"
                @keydown.enter="() => onCreateStoreShopify()"
            />

            <div class="mt-1 text-xs text-gray-500">
                {{ trans("Not sure which is your Shopify store name?") }} <a href="https://drive.google.com/file/d/1bdq3cQUvc3bussJfIMen5b4P4X-qw0W-/view" target="_blank" class="underline hover:text-gray-700">Click here</a>
            </div>

            <Transition name="slide-to-right">
                <div v-if="errorShopify" class="text-red-500 italic text-sm mt-2">
                    *{{ errorShopify }}
                </div>
            </Transition>

            <Button @click="() => onCreateStoreShopify()" full :label="trans('Connect')" :loading="!!isLoading" class="mt-6" />
        </div>
    </Modal>

    <!-- Modal: Manual -->
    <Modal :isOpen="isModalManual" @onClose="isModalManual = false" width="w-full max-w-lg">
        <div class="">
            <div class="mb-4">
                <div class="text-center font-semibold text-xl">
                    {{ trans("Create platform manual") }}
                </div>

                <div class="text-center text-xs text-gray-500">
                    {{ trans("Enter the name of manual platform") }}
                    <FontAwesomeIcon v-tooltip="trans('You can change the name later in Edit section')" icon="fal fa-info-circle" class="text-gray-400 hover:text-gray-600 cursor-pointer" fixed-width aria-hidden="true" />
                </div>
            </div>

            <div class="flex flex-col gap-y-2" :class="errManual ? 'errorShake' : ''">
                <PureInput
                    v-model="manualInput.name"
                    @update:modelValue="() => errManual = ''"
                    :placeholder="trans('Enter new store name')"
                    :maxLength="28"
                    @onEnter="() => onSubmitManual()"></PureInput>
            </div>

            <div v-if="errManual" class="text-red-500 italic text-sm mt-2">
                *{{ errManual }}
            </div>

            <Button @click="() => onSubmitManual()" full label="Create" :loading="!!isLoading" class="mt-6"/>
        </div>
    </Modal>

    <!-- Modal: Woocommerce -->
    <Modal :isOpen="isModalWooCommerce" @onClose="isModalWooCommerce = false" width="w-full max-w-lg">
        <div class="">
            <div class="mb-4">
                <div class="text-center font-semibold text-xl">
                    {{ trans("WooCommerce store Url") }}
                </div>

                <div class="text-center text-xs text-gray-500">
                    {{ trans("Enter your Woocommerce store url") }}
                </div>
            </div>

            <div class="flex flex-col gap-y-2">
                <PureInput v-model="wooCommerceInput.name" :placeholder="trans('Your store name')"></PureInput>
                <PureInputWithAddOn v-model="wooCommerceInput.url" :leftAddOn="{
                    icon: 'fal fa-globe'
                }" :placeholder="trans('e.g https://storeurlexample.com')"
                                    @keydown.enter="() => onSubmitWoocommerce()"/>
            </div>

            <Button @click="() => onSubmitWoocommerce()" full label="Create" :loading="!!isLoading" class="mt-6"/>
        </div>
    </Modal>

    <!-- Modal: Ebay -->
    <Modal :isOpen="isModalEbay" @onClose="isModalEbay = false" width="w-full max-w-lg">
        <div class="">
            <div>
                <div class="mx-auto flex size-12 items-center justify-center rounded-full bg-amber-100 border border-amber-300 text-xl">
                    <FontAwesomeIcon icon="fad fa-exclamation-triangle" class="text-amber-600" fixed-width aria-hidden="true" />
                </div>
                <div class="mt-3 text-center sm:mt-5">
                    <DialogTitle as="h3" class="text-base font-semibold text-amber-600">Warning</DialogTitle>
                    <div class="mt-2 text-amber-600">
                        <p class="text-sm">You already have a shop connected to our platform. To connect a different eBay shop, please log out from your current eBay account, use a separate browser profile, or switch to another browser.</p>
                    </div>
                </div>
            </div>
            <div class="mt-5 sm:mt-6">
                <Button
                    @click="() => onSubmitEbay()"
                    :label="trans('Connect')"
                    full
                    iconRight="fas fa-arrow-right"
                />
            </div>
        </div>
    </Modal>

    <!-- Modal: Magento -->
    <Modal :isOpen="isModalMagento" @onClose="isModalMagento = false" width="w-full max-w-lg">
        <div class="">
            <div class="mb-4">
                <div class="text-center font-semibold text-xl">
                    {{ trans("Magento store detail") }}
                </div>

                <div class="text-center text-xs text-gray-500">
                    {{ trans("Enter your Magento store detail") }}
                </div>
            </div>

            <div class="flex flex-col gap-y-2">
                <PureInput v-model="magentoInput.username" :placeholder="trans('Username')"></PureInput>
                <PurePassword v-model="magentoInput.password" :placeholder="trans('Password')"></PurePassword>
                <PureInputWithAddOn v-model="magentoInput.url" :leftAddOn="{
                    icon: 'fal fa-globe'
                }" :placeholder="trans('e.g https://storeurlexample.com')"
                                    @keydown.enter="() => onSubmitMagento()"/>
            </div>

            <Button @click="() => onSubmitMagento()" full label="Create" :loading="!!isLoading" class="mt-6"/>
        </div>
    </Modal>

    <Modal :isOpen="isModalEbayDuplicate" @onClose="() => {isModalEbayDuplicate = false}" width="w-full max-w-lg">
        <div>
        <div class="mb-4">
            <div class="text-center font-semibold text-xl">
            {{ trans('eBay Account Already Connected') }}
            </div>
            <div class="text-center text-xs text-gray-500 mt-2">
            {{ trans('To resolve this, try one of the following:') }}
            <ul class="list-disc list-inside mt-2 text-left text-gray-500">
                <li>{{ trans('Log out from your current eBay account.') }}</li>
                <li>{{ trans('Switch to another browser.') }}</li>
                <li>{{ trans('Use a separate browser profile.') }}</li>
            </ul>
            </div>
        </div>

        <div class="text-center">
            <Button @click="closeModalEbayDuplicate" label="OK" class="mt-4 px-6" />
        </div>
        </div>
    </Modal>

</template>
